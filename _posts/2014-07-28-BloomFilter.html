---
layout: post
title: "BloomFilter"
category: "算法"
---

<div style="line-height: 1.6; font-family: Helvetica Neue, Arial, Hiragino Sans GB, STHeiti, Microsoft YaHei, WenQuanYi Micro Hei, SimSun, Song, sans-serif;">
<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 30px; margin-bottom: 20px; font-size: 30px;">1. 原理</h2>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">BloomFilter 是一种基于 <strong style="font-weight: bold;">bit 数组 + 多重hash</strong> 的数据结构，用于判断一个元素是否在一个集合中。</p>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">BloomFilter 在内部维护一个长度为 m 的bit数组，并提供 k 个 hash 函数。当一个元素被加入集合时，用这些 hash 函数计算出 k 个数组位置并赋为 1。为了查询一个元素是否在集合中，同样地用 hash 函数计算出该元素在 bit 数组中的 k 个位置，如果全部为 1 就认为在集合中。</p>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">当k很大时，设计k个独立的hash function是不现实并且困难的。对于一个输出范围很大的hash function（例如MD5产生的128 bits数），如果不同bit位的相关性很小，则可把此输出分割为k份。或者可将k个不同的初始值（例如0,1,2, … ,k-1）结合元素，feed给一个hash function从而产生k个不同的数。</p>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">可以看到，BloomFilter 有两个缺点：</p>
<ol style="margin-top: 0; margin-bottom: 10px; line-height: 1.6;">
<li style="line-height: 1.6;">不支持 remove 元素；</li>
<li style="line-height: 1.6;">对一个不在集合中的元素，有可能误判；而且误判率会随着元素的增多而升高。因此不适合要求精确的场合。</li>
</ol>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">BloomFilter 最大的优点是它是基于 bit 数组的，不保存元素本身，因此非常节省空间；同等规模的集合，BloomFilter 占用的空间可能只有 HashSet 的 1/4 或更少。</p>
<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 30px; margin-bottom: 20px; font-size: 30px;">2. 误判率的计算</h2>
<blockquote style="padding: 15px 20px; margin: 0 0 15px 0; font-size: 14px; border-left: 5px solid #ddd; background-color: rgba(102, 128, 153, 0.05);">
<p style="margin: 0 0 10px; margin-bottom: 0; line-height: 1.6; font-size: 14px; font-weight: 300; white-space: pre-wrap; word-wrap: break-word;"> m:    bit 数组长度<br/>  n:    集合元素个数<br/>  k:    hash 函数个数<br/>  p:    误判概率</p>
</blockquote><p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">很显然，误判概率 p 是关于 m/n/k 的函数:</p>
<div style="margin: 20px 0; text-align: center;"><span></span><span style=""><div style="white-space: nowrap;"><span style="width: 7.903em; display: inline-block;"><span style="display: inline-block; position: relative; width: 5.955em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(1.734em 1000.003em 3.087em -0.538em); top: -2.649em; left: 0.003em;"><span><span style="font-family:MathJax_Math, serif; font-style: italic;">p</span><span style="font-family:MathJax_Main, serif; padding-left: 0.273em;">=</span><span style="font-family:MathJax_Math, serif; font-style: italic; padding-left: 0.273em;">f<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.057em;"></span></span><span style="font-family:MathJax_Main, serif;">(</span><span style="font-family:MathJax_Math, serif; font-style: italic;">m</span><span style="font-family:MathJax_Main, serif;">,</span><span style="font-family:MathJax_Math, serif; font-style: italic; padding-left: 0.165em;">n</span><span style="font-family:MathJax_Main, serif;">,</span><span style="font-family:MathJax_Math, serif; font-style: italic; padding-left: 0.165em;">k</span><span style="font-family:MathJax_Main, serif;">)</span></span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.432em; vertical-align: -0.425em;"></span></span></div></span></div>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">假设一个 hash 函数计算得到的位置等概率地分布在 bit 数组范围内，那么对于一个 bit 位，一次 hash 后它为 0 的概率是：</p>
<div style="margin: 20px 0; text-align: center;"><span></span><span style=""><div style="white-space: nowrap;"><span style="width: 3.899em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.925em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(1.139em 1000.003em 3.52em -0.376em); top: -2.649em; left: 0.003em;"><span><span style="font-family:MathJax_Main, serif;">1</span><span style="font-family:MathJax_Main, serif; padding-left: 0.219em;">−</span><span style="padding-left: 0.219em;"><span><span style="padding-left: 0.111em; padding-right: 0.111em;"><span style="display: inline-block; position: relative; width: 0.977em; height: 0px;"><span style="position: absolute; clip: rect(1.843em 1000.003em 2.817em -0.376em); top: -3.352em; left: 50%; margin-left: -0.214em;"><span style="font-family:MathJax_Main, serif;">1</span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span><span style="position: absolute; clip: rect(1.897em 1000.003em 2.654em -0.484em); top: -1.783em; left: 50%; margin-left: -0.43em;"><span style="font-family:MathJax_Math, serif; font-style: italic;">m</span><span style="display: inline-block; width: 0px; height: 2.492em;"></span></span><span style="position: absolute; clip: rect(0.869em 1000.003em 1.247em -0.484em); top: -1.296em; left: 0.003em;"><span style="border-left-width: 0.977em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em;"></span><span style="display: inline-block; width: 0px; height: 1.085em;"></span></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 2.861em; vertical-align: -0.996em;"></span></span></div></span></div>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">一个元素被加入集合后，该 bit 依然为 0 的概率是:</p>
<div style="margin: 20px 0; text-align: center;"><span></span><span style=""><div style="white-space: nowrap;"><span style="width: 5.468em; display: inline-block;"><span style="display: inline-block; position: relative; width: 4.115em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(1.139em 1000.003em 3.52em -0.376em); top: -2.649em; left: 0.003em;"><span><span style="font-family:MathJax_Main, serif;">(</span><span style="font-family:MathJax_Main, serif;">1</span><span style="font-family:MathJax_Main, serif; padding-left: 0.219em;">−</span><span style="padding-left: 0.219em;"><span><span style="padding-left: 0.111em; padding-right: 0.111em;"><span style="display: inline-block; position: relative; width: 0.977em; height: 0px;"><span style="position: absolute; clip: rect(1.843em 1000.003em 2.817em -0.376em); top: -3.352em; left: 50%; margin-left: -0.214em;"><span style="font-family:MathJax_Main, serif;">1</span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span><span style="position: absolute; clip: rect(1.897em 1000.003em 2.654em -0.484em); top: -1.783em; left: 50%; margin-left: -0.43em;"><span style="font-family:MathJax_Math, serif; font-style: italic;">m</span><span style="display: inline-block; width: 0px; height: 2.492em;"></span></span><span style="position: absolute; clip: rect(0.869em 1000.003em 1.247em -0.484em); top: -1.296em; left: 0.003em;"><span style="border-left-width: 0.977em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em;"></span><span style="display: inline-block; width: 0px; height: 1.085em;"></span></span></span></span></span></span><span><span style="display: inline-block; position: relative; width: 0.814em; height: 0px;"><span style="position: absolute; clip: rect(1.734em 1000.003em 3.087em -0.43em); top: -2.649em; left: 0.003em;"><span style="font-family:MathJax_Main, serif;">)</span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span><span style="position: absolute; top: -2.703em; left: 0.381em;"><span style="font-size: 70.7%; font-family:MathJax_Math, serif; font-style: italic;">k</span><span style="display: inline-block; width: 0px; height: 2.221em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 2.861em; vertical-align: -0.996em;"></span></span></div></span></div>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">n 个元素加入集合后，该 bit 为 0 的概率是：</p>
<div style="margin: 20px 0; text-align: center;"><span></span><span style=""><div style="white-space: nowrap;"><span style="width: 6.009em; display: inline-block;"><span style="display: inline-block; position: relative; width: 4.548em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(1.139em 1000.003em 3.52em -0.376em); top: -2.649em; left: 0.003em;"><span><span style="font-family:MathJax_Main, serif;">(</span><span style="font-family:MathJax_Main, serif;">1</span><span style="font-family:MathJax_Main, serif; padding-left: 0.219em;">−</span><span style="padding-left: 0.219em;"><span><span style="padding-left: 0.111em; padding-right: 0.111em;"><span style="display: inline-block; position: relative; width: 0.977em; height: 0px;"><span style="position: absolute; clip: rect(1.843em 1000.003em 2.817em -0.376em); top: -3.352em; left: 50%; margin-left: -0.214em;"><span style="font-family:MathJax_Main, serif;">1</span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span><span style="position: absolute; clip: rect(1.897em 1000.003em 2.654em -0.484em); top: -1.783em; left: 50%; margin-left: -0.43em;"><span style="font-family:MathJax_Math, serif; font-style: italic;">m</span><span style="display: inline-block; width: 0px; height: 2.492em;"></span></span><span style="position: absolute; clip: rect(0.869em 1000.003em 1.247em -0.484em); top: -1.296em; left: 0.003em;"><span style="border-left-width: 0.977em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em;"></span><span style="display: inline-block; width: 0px; height: 1.085em;"></span></span></span></span></span></span><span><span style="display: inline-block; position: relative; width: 1.247em; height: 0px;"><span style="position: absolute; clip: rect(1.734em 1000.003em 3.087em -0.43em); top: -2.649em; left: 0.003em;"><span style="font-family:MathJax_Main, serif;">)</span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span><span style="position: absolute; top: -2.703em; left: 0.381em;"><span><span><span style="font-size: 70.7%; font-family:MathJax_Math, serif; font-style: italic;">k</span><span style="font-size: 70.7%; font-family:MathJax_Math, serif; font-style: italic;">n</span></span></span><span style="display: inline-block; width: 0px; height: 2.221em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 2.861em; vertical-align: -0.996em;"></span></span></div></span></div>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">现在查询一个不在集合中的元素，当它所对应的 k 个位置都为 1 时会发生误判，这个概率 p 是：</p>
<div style="margin: 20px 0; text-align: center;"><span></span><span style=""><div style="white-space: nowrap;"><span style="width: 12.178em; display: inline-block;"><span style="display: inline-block; position: relative; width: 9.202em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(1.139em 1000.003em 3.52em -0.538em); top: -2.649em; left: 0.003em;"><span><span style="font-family:MathJax_Math, serif; font-style: italic;">p</span><span style="font-family:MathJax_Main, serif; padding-left: 0.273em;">=</span><span style="font-family:MathJax_Main, serif; padding-left: 0.273em;">(</span><span style="font-family:MathJax_Main, serif;">1</span><span style="font-family:MathJax_Main, serif; padding-left: 0.219em;">−</span><span style="font-family:MathJax_Main, serif; padding-left: 0.219em;">(</span><span style="font-family:MathJax_Main, serif;">1</span><span style="font-family:MathJax_Main, serif; padding-left: 0.219em;">−</span><span style="padding-left: 0.219em;"><span><span style="padding-left: 0.111em; padding-right: 0.111em;"><span style="display: inline-block; position: relative; width: 0.977em; height: 0px;"><span style="position: absolute; clip: rect(1.843em 1000.003em 2.817em -0.376em); top: -3.352em; left: 50%; margin-left: -0.214em;"><span style="font-family:MathJax_Main, serif;">1</span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span><span style="position: absolute; clip: rect(1.897em 1000.003em 2.654em -0.484em); top: -1.783em; left: 50%; margin-left: -0.43em;"><span style="font-family:MathJax_Math, serif; font-style: italic;">m</span><span style="display: inline-block; width: 0px; height: 2.492em;"></span></span><span style="position: absolute; clip: rect(0.869em 1000.003em 1.247em -0.484em); top: -1.296em; left: 0.003em;"><span style="border-left-width: 0.977em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em;"></span><span style="display: inline-block; width: 0px; height: 1.085em;"></span></span></span></span></span></span><span><span style="display: inline-block; position: relative; width: 1.247em; height: 0px;"><span style="position: absolute; clip: rect(1.734em 1000.003em 3.087em -0.43em); top: -2.649em; left: 0.003em;"><span style="font-family:MathJax_Main, serif;">)</span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span><span style="position: absolute; top: -2.703em; left: 0.381em;"><span><span><span style="font-size: 70.7%; font-family:MathJax_Math, serif; font-style: italic;">k</span><span style="font-size: 70.7%; font-family:MathJax_Math, serif; font-style: italic;">n</span></span></span><span style="display: inline-block; width: 0px; height: 2.221em;"></span></span></span></span><span><span style="display: inline-block; position: relative; width: 0.814em; height: 0px;"><span style="position: absolute; clip: rect(1.734em 1000.003em 3.087em -0.43em); top: -2.649em; left: 0.003em;"><span style="font-family:MathJax_Main, serif;">)</span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span><span style="position: absolute; top: -2.703em; left: 0.381em;"><span><span><span style="font-size: 70.7%; font-family:MathJax_Math, serif; font-style: italic;">k</span></span></span><span style="display: inline-block; width: 0px; height: 2.221em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 2.861em; vertical-align: -0.996em;"></span></span></div></span></div>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">由于 <span style="display:inline-block;margin:0"><span></span><span style=""><span style="white-space: nowrap;"><span style="width: 5.089em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.845em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(1.356em 1000.003em 3.087em -0.376em); top: -2.649em; left: 0.003em;"><span><span style="font-family:MathJax_Main, serif;">(</span><span style="font-family:MathJax_Main, serif;">1</span><span style="font-family:MathJax_Main, serif; padding-left: 0.219em;">+</span><span style="font-family:MathJax_Math, serif; font-style: italic; padding-left: 0.219em;">x</span><span><span style="display: inline-block; position: relative; width: 1.193em; height: 0px;"><span style="position: absolute; clip: rect(1.734em 1000.003em 3.087em -0.43em); top: -2.649em; left: 0.003em;"><span style="font-family:MathJax_Main, serif;">)</span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span><span style="position: absolute; top: -4.489em; left: 0.381em;"><span><span><span style="padding-left: 0.111em; padding-right: 0.111em;"><span style="display: inline-block; position: relative; width: 0.49em; height: 0px;"><span style="position: absolute; clip: rect(1.788em 1000.003em 2.438em -0.43em); top: -2.595em; left: 50%; margin-left: -0.16em;"><span style="font-size: 50%; font-family:MathJax_Main, serif;">1</span><span style="display: inline-block; width: 0px; height: 2.275em;"></span></span><span style="position: absolute; clip: rect(1.843em 1000.003em 2.384em -0.484em); top: -1.945em; left: 50%; margin-left: -0.16em;"><span style="font-size: 50%; font-family:MathJax_Math, serif; font-style: italic;">x</span><span style="display: inline-block; width: 0px; height: 2.221em;"></span></span><span style="position: absolute; clip: rect(0.869em 1000.003em 1.247em -0.484em); top: -1.242em; left: 0.003em;"><span style="border-left-width: 0.49em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em;"></span><span style="display: inline-block; width: 0px; height: 1.085em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 2.004em; vertical-align: -0.425em;"></span></span></span></span></span> 当x逼近0时约等于 <span style="display:inline-block;margin:0"><span></span><span style=""><span style="white-space: nowrap;"><span style="width: 0.598em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.436em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(1.897em 1000.003em 2.654em -0.43em); top: -2.486em; left: 0.003em;"><span><span style="font-family:MathJax_Math, serif; font-style: italic;">e</span></span><span style="display: inline-block; width: 0px; height: 2.492em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 0.718em; vertical-align: -0.068em;"></span></span></span></span></span>，因此有：</p>
<div style="margin: 20px 0; text-align: center;"><span></span><span style=""><div style="white-space: nowrap;"><span style="width: 8.282em; display: inline-block;"><span style="display: inline-block; position: relative; width: 6.28em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(1.464em 1000.003em 3.087em -0.538em); top: -2.649em; left: 0.003em;"><span><span style="font-family:MathJax_Math, serif; font-style: italic;">p</span><span style="font-family:MathJax_Main, serif; padding-left: 0.273em;">=</span><span style="font-family:MathJax_Main, serif; padding-left: 0.273em;">(</span><span style="font-family:MathJax_Main, serif;">1</span><span style="font-family:MathJax_Main, serif; padding-left: 0.219em;">−</span><span style="padding-left: 0.219em;"><span style="display: inline-block; position: relative; width: 1.572em; height: 0px;"><span style="position: absolute; clip: rect(1.897em 1000.003em 2.654em -0.43em); top: -2.486em; left: 0.003em;"><span style="font-family:MathJax_Math, serif; font-style: italic;">e</span><span style="display: inline-block; width: 0px; height: 2.492em;"></span></span><span style="position: absolute; top: -4.38em; left: 0.436em;"><span><span><span style="padding-left: 0.111em; padding-right: 0.111em;"><span style="display: inline-block; position: relative; width: 0.814em; height: 0px;"><span style="position: absolute; clip: rect(1.734em 1000.003em 2.384em -0.484em); top: -2.541em; left: 50%; margin-left: -0.322em;"><span><span style="font-size: 50%; font-family:MathJax_Math, serif; font-style: italic;">k</span><span style="font-size: 50%; font-family:MathJax_Math, serif; font-style: italic;">n</span></span><span style="display: inline-block; width: 0px; height: 2.221em;"></span></span><span style="position: absolute; clip: rect(1.843em 1000.003em 2.384em -0.484em); top: -1.945em; left: 50%; margin-left: -0.268em;"><span style="font-size: 50%; font-family:MathJax_Math, serif; font-style: italic;">m</span><span style="display: inline-block; width: 0px; height: 2.221em;"></span></span><span style="position: absolute; clip: rect(0.869em 1000.003em 1.247em -0.484em); top: -1.242em; left: 0.003em;"><span style="border-left-width: 0.814em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em;"></span><span style="display: inline-block; width: 0px; height: 1.085em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span><span><span style="display: inline-block; position: relative; width: 0.814em; height: 0px;"><span style="position: absolute; clip: rect(1.734em 1000.003em 3.087em -0.43em); top: -2.649em; left: 0.003em;"><span style="font-family:MathJax_Main, serif;">)</span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span><span style="position: absolute; top: -2.703em; left: 0.381em;"><span style="font-size: 70.7%; font-family:MathJax_Math, serif; font-style: italic;">k</span><span style="display: inline-block; width: 0px; height: 2.221em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.861em; vertical-align: -0.425em;"></span></span></div></span></div>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">对于该函数，省略<a href="http://www.cnblogs.com/allensun/archive/2011/02/16/1956532.html" style="background: transparent;" target="_blank">推导过程</a>给出结论，如果给定 m 和 n，当 k 取以下值时，误判率 p 的值最小：</p>
<div style="margin: 20px 0; text-align: center;"><span></span><span style=""><div style="white-space: nowrap;"><span style="width: 16.236em; display: inline-block;"><span style="display: inline-block; position: relative; width: 12.286em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(1.356em 1000.003em 3.52em -0.484em); top: -2.649em; left: 0.003em;"><span><span><span><span><span style="font-family:STIXGeneral, 'Arial Unicode MS', serif, serif; font-size: 76%; font-style: normal; font-weight: normal;">公</span></span></span></span><span><span><span><span style="font-family:STIXGeneral, 'Arial Unicode MS', serif, serif; font-size: 76%; font-style: normal; font-weight: normal;">式</span></span></span></span><span style="font-family:MathJax_Main, serif;">1</span><span><span><span><span style="font-family:STIXGeneral, 'Arial Unicode MS', serif, serif; font-size: 76%; font-style: normal; font-weight: normal;">：</span></span></span></span><span style="font-family:MathJax_Math, serif; font-style: italic;">k</span><span style="font-family:MathJax_Main, serif; padding-left: 0.273em;">=</span><span style="font-family:MathJax_Math, serif; font-style: italic; padding-left: 0.273em;">l</span><span style="font-family:MathJax_Math, serif; font-style: italic;">n</span><span style="font-family:MathJax_Main, serif;">2</span><span style="font-family:MathJax_Main, serif; padding-left: 0.219em;">⋅</span><span style="padding-left: 0.219em;"><span><span><span><span style="padding-left: 0.111em; padding-right: 0.111em;"><span style="display: inline-block; position: relative; width: 0.977em; height: 0px;"><span style="position: absolute; clip: rect(1.897em 1000.003em 2.654em -0.484em); top: -3.19em; left: 50%; margin-left: -0.43em;"><span style="font-family:MathJax_Math, serif; font-style: italic;">m</span><span style="display: inline-block; width: 0px; height: 2.492em;"></span></span><span style="position: absolute; clip: rect(1.897em 1000.003em 2.654em -0.484em); top: -1.783em; left: 50%; margin-left: -0.268em;"><span style="font-family:MathJax_Math, serif; font-style: italic;">n</span><span style="display: inline-block; width: 0px; height: 2.492em;"></span></span><span style="position: absolute; clip: rect(0.869em 1000.003em 1.247em -0.484em); top: -1.296em; left: 0.003em;"><span style="border-left-width: 0.977em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em;"></span><span style="display: inline-block; width: 0px; height: 1.085em;"></span></span></span></span></span></span></span></span><span style="font-family:MathJax_Main, serif; padding-left: 0.273em;">=</span><span style="font-family:MathJax_Main, serif; padding-left: 0.273em;">0.7</span><span style="font-family:MathJax_Main, serif; padding-left: 0.219em;">⋅</span><span style="padding-left: 0.219em;"><span><span><span><span style="padding-left: 0.111em; padding-right: 0.111em;"><span style="display: inline-block; position: relative; width: 0.977em; height: 0px;"><span style="position: absolute; clip: rect(1.897em 1000.003em 2.654em -0.484em); top: -3.19em; left: 50%; margin-left: -0.43em;"><span style="font-family:MathJax_Math, serif; font-style: italic;">m</span><span style="display: inline-block; width: 0px; height: 2.492em;"></span></span><span style="position: absolute; clip: rect(1.897em 1000.003em 2.654em -0.484em); top: -1.783em; left: 50%; margin-left: -0.268em;"><span style="font-family:MathJax_Math, serif; font-style: italic;">n</span><span style="display: inline-block; width: 0px; height: 2.492em;"></span></span><span style="position: absolute; clip: rect(0.869em 1000.003em 1.247em -0.484em); top: -1.296em; left: 0.003em;"><span style="border-left-width: 0.977em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em;"></span><span style="display: inline-block; width: 0px; height: 1.085em;"></span></span></span></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 2.575em; vertical-align: -0.996em;"></span></span></div></span></div>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">此时误判率 p 等于：</p>
<div style="margin: 20px 0; text-align: center;"><span></span><span style=""><div style="white-space: nowrap;"><span style="width: 22.946em; display: inline-block;"><span style="display: inline-block; position: relative; width: 17.373em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(1.139em 1000.003em 3.52em -0.484em); top: -2.649em; left: 0.003em;"><span><span><span><span><span style="font-family:STIXGeneral, 'Arial Unicode MS', serif, serif; font-size: 76%; font-style: normal; font-weight: normal;">公</span></span></span></span><span><span><span><span style="font-family:STIXGeneral, 'Arial Unicode MS', serif, serif; font-size: 76%; font-style: normal; font-weight: normal;">式</span></span></span></span><span style="font-family:MathJax_Main, serif;">2</span><span><span><span><span style="font-family:STIXGeneral, 'Arial Unicode MS', serif, serif; font-size: 76%; font-style: normal; font-weight: normal;">：</span></span></span></span><span><span style="display: inline-block; position: relative; width: 1.788em; height: 0px;"><span style="position: absolute; clip: rect(1.897em 1000.003em 2.871em -0.538em); top: -2.486em; left: 0.003em;"><span style="font-family:MathJax_Math, serif; font-style: italic;">p</span><span style="display: inline-block; width: 0px; height: 2.492em;"></span></span><span style="position: absolute; top: -1.999em; left: 0.49em;"><span><span><span style="font-size: 70.7%; font-family:MathJax_Math, serif; font-style: italic;">m</span><span style="font-size: 70.7%; font-family:MathJax_Math, serif; font-style: italic;">i</span><span style="font-size: 70.7%; font-family:MathJax_Math, serif; font-style: italic;">n</span></span></span><span style="display: inline-block; width: 0px; height: 2.221em;"></span></span></span></span><span style="font-family:MathJax_Main, serif; padding-left: 0.273em;">=</span><span style="font-family:MathJax_Main, serif; padding-left: 0.273em;">(</span><span style="font-family:MathJax_Main, serif;">1</span><span style="font-family:MathJax_Main, serif; padding-left: 0.219em;">−</span><span style="padding-left: 0.219em;"><span><span style="padding-left: 0.111em; padding-right: 0.111em;"><span style="display: inline-block; position: relative; width: 0.598em; height: 0px;"><span style="position: absolute; clip: rect(1.843em 1000.003em 2.817em -0.376em); top: -3.352em; left: 50%; margin-left: -0.214em;"><span style="font-family:MathJax_Main, serif;">1</span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span><span style="position: absolute; clip: rect(1.843em 1000.003em 2.817em -0.43em); top: -1.945em; left: 50%; margin-left: -0.214em;"><span style="font-family:MathJax_Main, serif;">2</span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span><span style="position: absolute; clip: rect(0.869em 1000.003em 1.247em -0.484em); top: -1.296em; left: 0.003em;"><span style="border-left-width: 0.598em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em;"></span><span style="display: inline-block; width: 0px; height: 1.085em;"></span></span></span></span></span></span><span><span style="display: inline-block; position: relative; width: 0.814em; height: 0px;"><span style="position: absolute; clip: rect(1.734em 1000.003em 3.087em -0.43em); top: -2.649em; left: 0.003em;"><span style="font-family:MathJax_Main, serif;">)</span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span><span style="position: absolute; top: -2.703em; left: 0.381em;"><span style="font-size: 70.7%; font-family:MathJax_Math, serif; font-style: italic;">k</span><span style="display: inline-block; width: 0px; height: 2.221em;"></span></span></span></span><span style="font-family:MathJax_Main, serif; padding-left: 0.273em;">=</span><span style="padding-left: 0.273em;"><span style="display: inline-block; position: relative; width: 1.464em; height: 0px;"><span style="position: absolute; clip: rect(1.843em 1000.003em 2.817em -0.43em); top: -2.649em; left: 0.003em;"><span style="font-family:MathJax_Main, serif;">2</span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span><span style="position: absolute; top: -2.649em; left: 0.49em;"><span><span><span style="font-size: 70.7%; font-family:MathJax_Main, serif;">−</span><span style="font-size: 70.7%; font-family:MathJax_Math, serif; font-style: italic;">k</span></span></span><span style="display: inline-block; width: 0px; height: 2.275em;"></span></span></span></span><span style="font-family:MathJax_Main, serif; padding-left: 0.273em;">=</span><span style="padding-left: 0.273em;"><span style="display: inline-block; position: relative; width: 3.736em; height: 0px;"><span style="position: absolute; clip: rect(1.843em 1000.003em 2.817em -0.43em); top: -2.649em; left: 0.003em;"><span style="font-family:MathJax_Main, serif;">0.6185</span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span><span style="position: absolute; top: -4.38em; left: 2.708em;"><span><span><span style="padding-left: 0.111em; padding-right: 0.111em;"><span style="display: inline-block; position: relative; width: 0.706em; height: 0px;"><span style="position: absolute; clip: rect(1.843em 1000.003em 2.384em -0.484em); top: -2.541em; left: 50%; margin-left: -0.268em;"><span style="font-size: 50%; font-family:MathJax_Math, serif; font-style: italic;">m</span><span style="display: inline-block; width: 0px; height: 2.221em;"></span></span><span style="position: absolute; clip: rect(1.843em 1000.003em 2.384em -0.484em); top: -1.945em; left: 50%; margin-left: -0.16em;"><span style="font-size: 50%; font-family:MathJax_Math, serif; font-style: italic;">n</span><span style="display: inline-block; width: 0px; height: 2.221em;"></span></span><span style="position: absolute; clip: rect(0.869em 1000.003em 1.247em -0.484em); top: -1.242em; left: 0.003em;"><span style="border-left-width: 0.706em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em;"></span><span style="display: inline-block; width: 0px; height: 1.085em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.654em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 2.789em; vertical-align: -0.996em;"></span></span></div></span></div>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">公式1 和 公式2 是实现一个 BloomFilter 需要的理论支撑。</p>
<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 30px; margin-bottom: 20px; font-size: 30px;">3. 实现</h2>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">一个 BloomFilter 需要用户提供两个参数：</p>
<ol style="margin-top: 0; margin-bottom: 10px; line-height: 1.6;">
<li style="line-height: 1.6;"><span style="display:inline-block;margin:0"><span></span><span style=""><span style="white-space: nowrap;"><span style="width: 0.814em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.598em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(1.897em 1000.003em 2.654em -0.484em); top: -2.486em; left: 0.003em;"><span><span style="font-family:MathJax_Math, serif; font-style: italic;">n</span></span><span style="display: inline-block; width: 0px; height: 2.492em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 0.718em; vertical-align: -0.068em;"></span></span></span></span></span>，预计集合规模；</li>
<li style="line-height: 1.6;"><span style="display:inline-block;margin:0"><span></span><span style=""><span style="white-space: nowrap;"><span style="width: 0.652em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.49em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(1.897em 1000.003em 2.871em -0.538em); top: -2.486em; left: 0.003em;"><span><span style="font-family:MathJax_Math, serif; font-style: italic;">p</span></span><span style="display: inline-block; width: 0px; height: 2.492em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.004em; vertical-align: -0.354em;"></span></span></span></span></span>，当元素个数达到 n 时，可以接受的误判率</li>
</ol>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">bit 数组长度 <span style="display:inline-block;margin:0"><span></span><span style=""><span style="white-space: nowrap;"><span style="width: 1.139em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.869em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(1.897em 1000.003em 2.654em -0.484em); top: -2.486em; left: 0.003em;"><span><span style="font-family:MathJax_Math, serif; font-style: italic;">m</span></span><span style="display: inline-block; width: 0px; height: 2.492em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 0.718em; vertical-align: -0.068em;"></span></span></span></span></span> 和 hash 函数个数 <span style="display:inline-block;margin:0"><span></span><span style=""><span style="white-space: nowrap;"><span style="width: 0.652em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.49em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(1.626em 1000.003em 2.654em -0.43em); top: -2.486em; left: 0.003em;"><span><span style="font-family:MathJax_Math, serif; font-style: italic;">k</span></span><span style="display: inline-block; width: 0px; height: 2.492em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.075em; vertical-align: -0.068em;"></span></span></span></span></span> 在初始化时由上述两个公式计算而得。</p>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">在爬虫项目中用了 BloomFilter 作为 url 的判重器，代码在<a href="http://gist.github.com/novoland/9277fe26b4ec91cb3ee6" style="background: transparent;" target="_blank">这里</a>。其中 k 个 hash 函数是通过为 MD5 提供 k 个不同的 salt 构造的。实际使用中当集合规模为 500 万，误判率为万分之一时，所占空间仅为 11.5M。</p>
</div>