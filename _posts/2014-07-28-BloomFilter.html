---
layout: post
title: "BloomFilter"
category: "算法"
---

<div style="line-height: 1.6; font-family: Helvetica Neue, Arial, Hiragino Sans GB, STHeiti, Microsoft YaHei, WenQuanYi Micro Hei, SimSun, Song, sans-serif;">
<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 30px; margin-bottom: 20px; font-size: 30px;">1. 原理</h2>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">BloomFilter 是一种基于 <strong style="font-weight: bold; margin-top: 0px;">bit 数组 + 多重hash</strong> 的数据结构，用于判断一个元素是否在一个集合中。</p>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">BloomFilter 在内部维护一个长度为 m 的bit数组，并提供 k 个 hash 函数。当一个元素被加入集合时，用这些 hash 函数计算出 k 个数组位置并赋为 1。为了查询一个元素是否在集合中，同样地用 hash 函数计算出该元素在 bit 数组中的 k 个位置，如果全部为 1 就认为在集合中。</p>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">当k很大时，设计k个独立的hash function是不现实并且困难的。对于一个输出范围很大的hash function（例如MD5产生的128 bits数），如果不同bit位的相关性很小，则可把此输出分割为k份。或者可将k个不同的初始值（例如0,1,2, … ,k-1）结合元素，feed给一个hash function从而产生k个不同的数。</p>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">可以看到，BloomFilter 有两个缺点：</p>
<ol style="margin-top: 0; margin-bottom: 10px; line-height: 1.6;">
<li style="line-height: 1.6; margin-top: 0px;">不支持 remove 元素；</li>
<li style="line-height: 1.6;">对一个不在集合中的元素，有可能误判；而且误判率会随着元素的增多而升高。因此不适合要求精确的场合。</li>
</ol>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">BloomFilter 最大的优点是它是基于 bit 数组的，不保存元素本身，因此非常节省空间；同等规模的集合，BloomFilter 占用的空间可能只有 HashSet 的 1/4 或更少。</p>
<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 30px; margin-bottom: 20px; font-size: 30px;">2. 误判率的计算</h2>
<blockquote style="padding: 15px 20px; margin: 0 0 15px 0; font-size: 14px; border-left: 5px solid #ddd; background-color: rgba(102, 128, 153, 0.05);">
<p style="margin: 0 0 10px; margin-bottom: 0; line-height: 1.6; font-size: 14px; font-weight: 300; white-space: pre-wrap; word-wrap: break-word; margin-top: 0px;"> m:    bit 数组长度<br style="margin-top: 0px;"/>  n:    集合元素个数<br/>  k:    hash 函数个数<br/>  p:    误判概率</p>
</blockquote><p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">很显然，误判概率 p 是关于 m/n/k 的函数:</p>
<div style="margin: 20px 0; text-align: center;"><span style="margin-top: 0px;"></span><span><div style="white-space: nowrap; margin-top: 0px;"><span style="width: 6.551em; display: inline-block; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 5.42em; height: 0px; font-size: 120%; margin-top: 0px;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.92em -0.592em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-family: STIXGeneral-Italic, serif; margin-top: 0px;">p</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.301em;">=</span><span style="font-family:STIXGeneral-Italic, serif; padding-left: 0.301em;">f<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.122em; margin-top: 0px;"></span></span><span style="font-family:STIXGeneral-Regular, serif;">(</span><span style="font-family:STIXGeneral-Italic, serif;">m</span><span style="font-family:STIXGeneral-Regular, serif;">,</span><span style="font-family:STIXGeneral-Italic, serif; padding-left: 0.182em;">n</span><span style="font-family:STIXGeneral-Regular, serif;">,</span><span style="font-family:STIXGeneral-Italic, serif; padding-left: 0.182em;">k<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em; margin-top: 0px;"></span></span><span style="font-family:STIXGeneral-Regular, serif;">)</span></span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.218em; vertical-align: -0.282em;"></span></span></div></span></div>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">假设一个 hash 函数计算得到的位置等概率地分布在 bit 数组范围内，那么对于一个 bit 位，一次 hash 后它为 0 的概率是：</p>
<div style="margin: 20px 0; text-align: center;"><span style="margin-top: 0px;"></span><span><div style="white-space: nowrap; margin-top: 0px;"><span style="width: 3.396em; display: inline-block; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 2.801em; height: 0px; font-size: 120%; margin-top: 0px;"><span style="position: absolute; clip: rect(1.015em 1000.003em 3.455em -0.414em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-family: STIXGeneral-Regular, serif; margin-top: 0px;">1</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.241em;">−</span><span style="padding-left: 0.241em;"><span style="margin-top: 0px;"><span style="padding-left: 0.122em; padding-right: 0.122em; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 0.896em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.741em -0.414em); top: -3.211em; left: 50%; margin-left: -0.235em; margin-top: 0px;"><span style="font-family: STIXGeneral-Regular, serif; margin-top: 0px;">1</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; clip: rect(1.967em 1000.003em 2.741em -0.533em); top: -1.842em; left: 50%; margin-left: -0.354em;"><span style="font-family: STIXGeneral-Italic, serif; margin-top: 0px;">m</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; clip: rect(0.836em 1000.003em 1.253em -0.533em); top: -1.307em; left: 0.003em;"><span style="border-left-width: 0.896em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em; margin-top: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.074em;"></span></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 2.575em; vertical-align: -0.925em;"></span></span></div></span></div>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">一个元素被加入集合后，该 bit 依然为 0 的概率是:</p>
<div style="margin: 20px 0; text-align: center;"><span style="margin-top: 0px;"></span><span><div style="white-space: nowrap; margin-top: 0px;"><span style="width: 4.765em; display: inline-block; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 3.932em; height: 0px; font-size: 120%; margin-top: 0px;"><span style="position: absolute; clip: rect(1.015em 1000.003em 3.455em -0.473em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-family: STIXGeneral-Regular, serif; margin-top: 0px;">(</span><span style="font-family:STIXGeneral-Regular, serif;">1</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.241em;">−</span><span style="padding-left: 0.241em;"><span style="margin-top: 0px;"><span style="padding-left: 0.122em; padding-right: 0.122em; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 0.896em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.741em -0.414em); top: -3.211em; left: 50%; margin-left: -0.235em; margin-top: 0px;"><span style="font-family: STIXGeneral-Regular, serif; margin-top: 0px;">1</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; clip: rect(1.967em 1000.003em 2.741em -0.533em); top: -1.842em; left: 50%; margin-left: -0.354em;"><span style="font-family: STIXGeneral-Italic, serif; margin-top: 0px;">m</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; clip: rect(0.836em 1000.003em 1.253em -0.533em); top: -1.307em; left: 0.003em;"><span style="border-left-width: 0.896em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em; margin-top: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.074em;"></span></span></span></span></span></span><span><span style="display: inline-block; position: relative; width: 0.777em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.92em -0.533em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="font-family: STIXGeneral-Regular, serif; margin-top: 0px;">)</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; top: -2.676em; left: 0.36em;"><span style="font-size: 70.7%; font-family: STIXGeneral-Italic, serif; margin-top: 0px;">k<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em; margin-top: 0px;"></span></span><span style="display: inline-block; width: 0px; height: 2.265em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 2.575em; vertical-align: -0.925em;"></span></span></div></span></div>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">n 个元素加入集合后，该 bit 为 0 的概率是：</p>
<div style="margin: 20px 0; text-align: center;"><span style="margin-top: 0px;"></span><span><div style="white-space: nowrap; margin-top: 0px;"><span style="width: 5.182em; display: inline-block; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 4.289em; height: 0px; font-size: 120%; margin-top: 0px;"><span style="position: absolute; clip: rect(1.015em 1000.003em 3.455em -0.473em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-family: STIXGeneral-Regular, serif; margin-top: 0px;">(</span><span style="font-family:STIXGeneral-Regular, serif;">1</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.241em;">−</span><span style="padding-left: 0.241em;"><span style="margin-top: 0px;"><span style="padding-left: 0.122em; padding-right: 0.122em; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 0.896em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.741em -0.414em); top: -3.211em; left: 50%; margin-left: -0.235em; margin-top: 0px;"><span style="font-family: STIXGeneral-Regular, serif; margin-top: 0px;">1</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; clip: rect(1.967em 1000.003em 2.741em -0.533em); top: -1.842em; left: 50%; margin-left: -0.354em;"><span style="font-family: STIXGeneral-Italic, serif; margin-top: 0px;">m</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; clip: rect(0.836em 1000.003em 1.253em -0.533em); top: -1.307em; left: 0.003em;"><span style="border-left-width: 0.896em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em; margin-top: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.074em;"></span></span></span></span></span></span><span><span style="display: inline-block; position: relative; width: 1.134em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.92em -0.533em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="font-family: STIXGeneral-Regular, serif; margin-top: 0px;">)</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; top: -2.676em; left: 0.36em;"><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-size: 70.7%; font-family: STIXGeneral-Italic, serif; margin-top: 0px;">k<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em; margin-top: 0px;"></span></span><span style="font-size: 70.7%; font-family:STIXGeneral-Italic, serif;">n</span></span></span><span style="display: inline-block; width: 0px; height: 2.265em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 2.575em; vertical-align: -0.925em;"></span></span></div></span></div>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">现在查询一个不在集合中的元素，当它所对应的 k 个位置都为 1 时会发生误判，这个概率 p 是：</p>
<div style="margin: 20px 0; text-align: center;"><span style="margin-top: 0px;"></span><span><div style="white-space: nowrap; margin-top: 0px;"><span style="width: 10.658em; display: inline-block; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 8.872em; height: 0px; font-size: 120%; margin-top: 0px;"><span style="position: absolute; clip: rect(1.015em 1000.003em 3.455em -0.592em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-family: STIXGeneral-Italic, serif; margin-top: 0px;">p</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.301em;">=</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.301em;">(</span><span style="font-family:STIXGeneral-Regular, serif;">1</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.241em;">−</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.241em;">(</span><span style="font-family:STIXGeneral-Regular, serif;">1</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.241em;">−</span><span style="padding-left: 0.241em;"><span style="margin-top: 0px;"><span style="padding-left: 0.122em; padding-right: 0.122em; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 0.896em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.741em -0.414em); top: -3.211em; left: 50%; margin-left: -0.235em; margin-top: 0px;"><span style="font-family: STIXGeneral-Regular, serif; margin-top: 0px;">1</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; clip: rect(1.967em 1000.003em 2.741em -0.533em); top: -1.842em; left: 50%; margin-left: -0.354em;"><span style="font-family: STIXGeneral-Italic, serif; margin-top: 0px;">m</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; clip: rect(0.836em 1000.003em 1.253em -0.533em); top: -1.307em; left: 0.003em;"><span style="border-left-width: 0.896em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em; margin-top: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.074em;"></span></span></span></span></span></span><span><span style="display: inline-block; position: relative; width: 1.134em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.92em -0.533em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="font-family: STIXGeneral-Regular, serif; margin-top: 0px;">)</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; top: -2.676em; left: 0.36em;"><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-size: 70.7%; font-family: STIXGeneral-Italic, serif; margin-top: 0px;">k<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em; margin-top: 0px;"></span></span><span style="font-size: 70.7%; font-family:STIXGeneral-Italic, serif;">n</span></span></span><span style="display: inline-block; width: 0px; height: 2.265em;"></span></span></span></span><span><span style="display: inline-block; position: relative; width: 0.777em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.92em -0.533em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="font-family: STIXGeneral-Regular, serif; margin-top: 0px;">)</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; top: -2.676em; left: 0.36em;"><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-size: 70.7%; font-family: STIXGeneral-Italic, serif; margin-top: 0px;">k<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em; margin-top: 0px;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.265em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 2.575em; vertical-align: -0.925em;"></span></span></div></span></div>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">由于 <span style="display: inline-block; margin: 0; margin-top: 0px;"><span style="margin-top: 0px;"></span><span><span style="white-space: nowrap; margin-top: 0px;"><span style="width: 4.408em; display: inline-block; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 3.634em; height: 0px; font-size: 120%; margin-top: 0px;"><span style="position: absolute; clip: rect(1.313em 1000.003em 2.92em -0.473em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-family: STIXGeneral-Regular, serif; margin-top: 0px;">(</span><span style="font-family:STIXGeneral-Regular, serif;">1</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.241em;">+</span><span style="font-family:STIXGeneral-Italic, serif; padding-left: 0.241em;">x<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em; margin-top: 0px;"></span></span><span><span style="display: inline-block; position: relative; width: 1.134em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.92em -0.533em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="font-family: STIXGeneral-Regular, serif; margin-top: 0px;">)</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; top: -4.402em; left: 0.36em;"><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="padding-left: 0.122em; padding-right: 0.122em; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 0.479em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.443em -0.473em); top: -2.616em; left: 50%; margin-left: -0.176em; margin-top: 0px;"><span style="font-size: 50%; font-family: STIXGeneral-Regular, serif; margin-top: 0px;">1</span><span style="display: inline-block; width: 0px; height: 2.265em;"></span></span><span style="position: absolute; clip: rect(1.848em 1000.003em 2.443em -0.533em); top: -2.021em; left: 50%; margin-left: -0.176em;"><span style="font-size: 50%; font-family: STIXGeneral-Italic, serif; margin-top: 0px;">x<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em; margin-top: 0px;"></span></span><span style="display: inline-block; width: 0px; height: 2.265em;"></span></span><span style="position: absolute; clip: rect(0.836em 1000.003em 1.253em -0.533em); top: -1.188em; left: 0.003em;"><span style="border-left-width: 0.479em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em; margin-top: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.074em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.991em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.646em; vertical-align: -0.282em;"></span></span></span></span></span> 当x逼近0时约等于 <span style="display:inline-block;margin:0"><span style="margin-top: 0px;"></span><span><span style="white-space: nowrap; margin-top: 0px;"><span style="width: 0.598em; display: inline-block; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 0.479em; height: 0px; font-size: 120%; margin-top: 0px;"><span style="position: absolute; clip: rect(1.967em 1000.003em 2.741em -0.473em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-family: STIXGeneral-Italic, serif; margin-top: 0px;">e</span></span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 0.718em; vertical-align: -0.068em;"></span></span></span></span></span>，因此有：</p>
<div style="margin: 20px 0; text-align: center;"><span style="margin-top: 0px;"></span><span><div style="white-space: nowrap; margin-top: 0px;"><span style="width: 7.443em; display: inline-block; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 6.193em; height: 0px; font-size: 120%; margin-top: 0px;"><span style="position: absolute; clip: rect(1.313em 1000.003em 2.92em -0.592em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-family: STIXGeneral-Italic, serif; margin-top: 0px;">p</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.301em;">=</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.301em;">(</span><span style="font-family:STIXGeneral-Regular, serif;">1</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.241em;">−</span><span style="padding-left: 0.241em;"><span style="display: inline-block; position: relative; width: 1.61em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.967em 1000.003em 2.741em -0.473em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="font-family: STIXGeneral-Italic, serif; margin-top: 0px;">e</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; top: -4.342em; left: 0.479em;"><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="padding-left: 0.122em; padding-right: 0.122em; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 0.836em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.443em -0.533em); top: -2.616em; left: 50%; margin-left: -0.354em; margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-size: 50%; font-family: STIXGeneral-Italic, serif; margin-top: 0px;">k<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em; margin-top: 0px;"></span></span><span style="font-size: 50%; font-family:STIXGeneral-Italic, serif;">n</span></span><span style="display: inline-block; width: 0px; height: 2.265em;"></span></span><span style="position: absolute; clip: rect(1.848em 1000.003em 2.443em -0.533em); top: -2.021em; left: 50%; margin-left: -0.235em;"><span style="font-size: 50%; font-family: STIXGeneral-Italic, serif; margin-top: 0px;">m</span><span style="display: inline-block; width: 0px; height: 2.265em;"></span></span><span style="position: absolute; clip: rect(0.836em 1000.003em 1.253em -0.533em); top: -1.188em; left: 0.003em;"><span style="border-left-width: 0.836em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em; margin-top: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.074em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.991em;"></span></span></span></span><span><span style="display: inline-block; position: relative; width: 0.777em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.92em -0.533em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="font-family: STIXGeneral-Regular, serif; margin-top: 0px;">)</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; top: -2.676em; left: 0.36em;"><span style="font-size: 70.7%; font-family: STIXGeneral-Italic, serif; margin-top: 0px;">k<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em; margin-top: 0px;"></span></span><span style="display: inline-block; width: 0px; height: 2.265em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.646em; vertical-align: -0.282em;"></span></span></div></span></div>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">对于该函数，省略<a href="http://www.cnblogs.com/allensun/archive/2011/02/16/1956532.html" style="background: transparent; margin-top: 0px;" target="_blank">推导过程</a>给出结论，如果给定 m 和 n，当 k 取以下值时，误判率 p 的值最小：</p>
<div style="margin: 20px 0; text-align: center;"><span style="margin-top: 0px;"></span><span><div style="white-space: nowrap; margin-top: 0px;"><span style="width: 14.824em; display: inline-block; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 12.324em; height: 0px; font-size: 120%; margin-top: 0px;"><span style="position: absolute; clip: rect(1.253em 1000.003em 3.455em -0.533em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-family: STIXGeneral, Arial Unicode MS, serif, serif; font-size: 83%; font-style: normal; font-weight: normal; margin-top: 0px;">公</span></span></span></span><span><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-family: STIXGeneral, Arial Unicode MS, serif, serif; font-size: 83%; font-style: normal; font-weight: normal; margin-top: 0px;">式</span></span></span></span><span style="font-family:STIXGeneral-Regular, serif;">1</span><span><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-family: STIXGeneral, Arial Unicode MS, serif, serif; font-size: 83%; font-style: normal; font-weight: normal; margin-top: 0px;">：</span></span></span></span><span style="font-family:STIXGeneral-Italic, serif;">k<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em; margin-top: 0px;"></span></span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.301em;">=</span><span style="font-family:STIXGeneral-Italic, serif; padding-left: 0.301em;">l<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em; margin-top: 0px;"></span></span><span style="font-family:STIXGeneral-Italic, serif;">n</span><span style="font-family:STIXGeneral-Regular, serif;">2</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.241em;">⋅</span><span style="padding-left: 0.241em;"><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="padding-left: 0.122em; padding-right: 0.122em; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 0.896em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.967em 1000.003em 2.741em -0.533em); top: -3.211em; left: 50%; margin-left: -0.354em; margin-top: 0px;"><span style="font-family: STIXGeneral-Italic, serif; margin-top: 0px;">m</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; clip: rect(1.967em 1000.003em 2.741em -0.533em); top: -1.842em; left: 50%; margin-left: -0.235em;"><span style="font-family: STIXGeneral-Italic, serif; margin-top: 0px;">n</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; clip: rect(0.836em 1000.003em 1.253em -0.533em); top: -1.307em; left: 0.003em;"><span style="border-left-width: 0.896em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em; margin-top: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.074em;"></span></span></span></span></span></span></span></span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.301em;">=</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.301em;">0.7</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.241em;">⋅</span><span style="padding-left: 0.241em;"><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="padding-left: 0.122em; padding-right: 0.122em; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 0.896em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.967em 1000.003em 2.741em -0.533em); top: -3.211em; left: 50%; margin-left: -0.354em; margin-top: 0px;"><span style="font-family: STIXGeneral-Italic, serif; margin-top: 0px;">m</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; clip: rect(1.967em 1000.003em 2.741em -0.533em); top: -1.842em; left: 50%; margin-left: -0.235em;"><span style="font-family: STIXGeneral-Italic, serif; margin-top: 0px;">n</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; clip: rect(0.836em 1000.003em 1.253em -0.533em); top: -1.307em; left: 0.003em;"><span style="border-left-width: 0.896em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em; margin-top: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.074em;"></span></span></span></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 2.289em; vertical-align: -0.925em;"></span></span></div></span></div>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">此时误判率 p 等于：</p>
<div style="margin: 20px 0; text-align: center;"><span style="margin-top: 0px;"></span><span><div style="white-space: nowrap; margin-top: 0px;"><span style="width: 20.896em; display: inline-block; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 17.384em; height: 0px; font-size: 120%; margin-top: 0px;"><span style="position: absolute; clip: rect(1.015em 1000.003em 3.455em -0.533em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-family: STIXGeneral, Arial Unicode MS, serif, serif; font-size: 83%; font-style: normal; font-weight: normal; margin-top: 0px;">公</span></span></span></span><span><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-family: STIXGeneral, Arial Unicode MS, serif, serif; font-size: 83%; font-style: normal; font-weight: normal; margin-top: 0px;">式</span></span></span></span><span style="font-family:STIXGeneral-Regular, serif;">2</span><span><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-family: STIXGeneral, Arial Unicode MS, serif, serif; font-size: 83%; font-style: normal; font-weight: normal; margin-top: 0px;">：</span></span></span></span><span><span style="display: inline-block; position: relative; width: 1.67em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.967em 1000.003em 2.92em -0.592em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="font-family: STIXGeneral-Italic, serif; margin-top: 0px;">p</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; top: -2.021em; left: 0.539em;"><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-size: 70.7%; font-family: STIXGeneral-Italic, serif; margin-top: 0px;">m</span><span style="font-size: 70.7%; font-family:STIXGeneral-Italic, serif;">i</span><span style="font-size: 70.7%; font-family:STIXGeneral-Italic, serif;">n</span></span></span><span style="display: inline-block; width: 0px; height: 2.265em;"></span></span></span></span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.301em;">=</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.301em;">(</span><span style="font-family:STIXGeneral-Regular, serif;">1</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.241em;">−</span><span style="padding-left: 0.241em;"><span style="margin-top: 0px;"><span style="padding-left: 0.122em; padding-right: 0.122em; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 0.658em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.741em -0.414em); top: -3.211em; left: 50%; margin-left: -0.235em; margin-top: 0px;"><span style="font-family: STIXGeneral-Regular, serif; margin-top: 0px;">1</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; clip: rect(1.729em 1000.003em 2.741em -0.533em); top: -1.842em; left: 50%; margin-left: -0.235em;"><span style="font-family: STIXGeneral-Regular, serif; margin-top: 0px;">2</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; clip: rect(0.836em 1000.003em 1.253em -0.533em); top: -1.307em; left: 0.003em;"><span style="border-left-width: 0.658em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em; margin-top: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.074em;"></span></span></span></span></span></span><span><span style="display: inline-block; position: relative; width: 0.777em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.92em -0.533em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="font-family: STIXGeneral-Regular, serif; margin-top: 0px;">)</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; top: -2.676em; left: 0.36em;"><span style="font-size: 70.7%; font-family: STIXGeneral-Italic, serif; margin-top: 0px;">k<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em; margin-top: 0px;"></span></span><span style="display: inline-block; width: 0px; height: 2.265em;"></span></span></span></span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.301em;">=</span><span style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 1.432em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.741em -0.533em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="font-family: STIXGeneral-Regular, serif; margin-top: 0px;">2</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; top: -2.676em; left: 0.539em;"><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-size: 70.7%; font-family: STIXGeneral-Regular, serif; margin-top: 0px;">−</span><span style="font-size: 70.7%; font-family:STIXGeneral-Italic, serif;">k<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em; margin-top: 0px;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.265em;"></span></span></span></span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.301em;">=</span><span style="padding-left: 0.301em;"><span style="display: inline-block; position: relative; width: 3.753em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.67em 1000.003em 2.741em -0.533em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="font-family: STIXGeneral-Regular, serif; margin-top: 0px;">0.6185</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; top: -4.402em; left: 2.801em;"><span style="margin-top: 0px;"><span style="margin-top: 0px;"><span style="padding-left: 0.122em; padding-right: 0.122em; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 0.658em; height: 0px; margin-top: 0px;"><span style="position: absolute; clip: rect(1.848em 1000.003em 2.443em -0.533em); top: -2.616em; left: 50%; margin-left: -0.235em; margin-top: 0px;"><span style="font-size: 50%; font-family: STIXGeneral-Italic, serif; margin-top: 0px;">m</span><span style="display: inline-block; width: 0px; height: 2.265em;"></span></span><span style="position: absolute; clip: rect(1.848em 1000.003em 2.443em -0.533em); top: -2.021em; left: 50%; margin-left: -0.176em;"><span style="font-size: 50%; font-family: STIXGeneral-Italic, serif; margin-top: 0px;">n</span><span style="display: inline-block; width: 0px; height: 2.265em;"></span></span><span style="position: absolute; clip: rect(0.836em 1000.003em 1.253em -0.533em); top: -1.188em; left: 0.003em;"><span style="border-left-width: 0.658em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em; margin-top: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.074em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.991em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 2.575em; vertical-align: -0.925em;"></span></span></div></span></div>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">公式1 和 公式2 是实现一个 BloomFilter 需要的理论支撑。</p>
<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 30px; margin-bottom: 20px; font-size: 30px;">3. 实现</h2>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">一个 BloomFilter 需要用户提供两个参数：</p>
<ol style="margin-top: 0; margin-bottom: 10px; line-height: 1.6;">
<li style="line-height: 1.6; margin-top: 0px;"><span style="display: inline-block; margin: 0; margin-top: 0px;"><span style="margin-top: 0px;"></span><span><span style="white-space: nowrap; margin-top: 0px;"><span style="width: 0.658em; display: inline-block; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 0.539em; height: 0px; font-size: 120%; margin-top: 0px;"><span style="position: absolute; clip: rect(1.967em 1000.003em 2.741em -0.533em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-family: STIXGeneral-Italic, serif; margin-top: 0px;">n</span></span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 0.718em; vertical-align: -0.068em;"></span></span></span></span></span>，预计集合规模；</li>
<li style="line-height: 1.6;"><span style="display: inline-block; margin: 0; margin-top: 0px;"><span style="margin-top: 0px;"></span><span><span style="white-space: nowrap; margin-top: 0px;"><span style="width: 0.658em; display: inline-block; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 0.539em; height: 0px; font-size: 120%; margin-top: 0px;"><span style="position: absolute; clip: rect(1.967em 1000.003em 2.92em -0.592em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-family: STIXGeneral-Italic, serif; margin-top: 0px;">p</span></span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 0.932em; vertical-align: -0.282em;"></span></span></span></span></span>，当元素个数达到 n 时，可以接受的误判率</li>
</ol>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">bit 数组长度 <span style="display: inline-block; margin: 0; margin-top: 0px;"><span style="margin-top: 0px;"></span><span><span style="white-space: nowrap; margin-top: 0px;"><span style="width: 0.955em; display: inline-block; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 0.777em; height: 0px; font-size: 120%; margin-top: 0px;"><span style="position: absolute; clip: rect(1.967em 1000.003em 2.741em -0.533em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-family: STIXGeneral-Italic, serif; margin-top: 0px;">m</span></span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 0.718em; vertical-align: -0.068em;"></span></span></span></span></span> 和 hash 函数个数 <span style="display:inline-block;margin:0"><span style="margin-top: 0px;"></span><span><span style="white-space: nowrap; margin-top: 0px;"><span style="width: 0.598em; display: inline-block; margin-top: 0px;"><span style="display: inline-block; position: relative; width: 0.479em; height: 0px; font-size: 120%; margin-top: 0px;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.741em -0.533em); top: -2.557em; left: 0.003em; margin-top: 0px;"><span style="margin-top: 0px;"><span style="font-family: STIXGeneral-Italic, serif; margin-top: 0px;">k<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em; margin-top: 0px;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.004em; vertical-align: -0.068em;"></span></span></span></span></span> 在初始化时由上述两个公式计算而得。</p>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">在爬虫项目中用了 BloomFilter 作为 url 的判重器，代码在<a href="http://gist.github.com/novoland/9277fe26b4ec91cb3ee6" style="background: transparent; margin-top: 0px;" target="_blank">这里</a>。其中 k 个 hash 函数是通过为 MD5 提供 k 个不同的 salt 构造的。实际使用中当集合规模为 500 万，误判率为万分之一时，所占空间仅为 11.5M。</p>
<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 30px; margin-bottom: 20px; font-size: 30px;">4. 其他技巧</h2>
<ol style="margin-top: 0; margin-bottom: 10px; line-height: 1.6;">
<li style="line-height: 1.6; margin-top: 0px;"><p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; margin-top: 0px;">两个 BloomFilter 的交集、并集</p>
<pre style="overflow: initial; font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 14px; display: block; padding: 0; margin: 0 0 10px; line-height: 1.6; word-break: break-all; word-wrap: break-word; color: #333333; background-color: #f5f5f5; border: none; border-radius: 0; white-space: pre-wrap;" xml:space="preserve"><code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: inherit; padding: 1em; color: #f8f8f2; background-color: transparent; white-space: pre-wrap; border-radius: 0; display: block; background: #23241f; margin-top: 0px;">filter1 | filter2 == 并集
filter1 &amp; filter2 == 交集
</code></pre>
</li>
<li style="line-height: 1.6;"><p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; margin-top: 0px;"><strong style="font-weight: bold; margin-top: 0px;"><code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 90%; padding: 2px 4px; color: #c7254e; background-color: #f9f2f4; white-space: nowrap; border-radius: 4px; margin-top: 0px;">counting BloomFilter</code></strong></p>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">传统 BloomFilter 只能添加元素，不能对元素计数，也无法删除元素。如果把底层数组的 bit 换成 int，就可以支持计数和删除动作。每次插入元素时，将对应的 k 个 int 加一；查询时，返回 k 个 int 的最小值；删除时，将对应的 k 个 int 减一。</p>
</li>
</ol>
</div>