---
layout: post
title: "堆"
category: "算法"
---

<div style="line-height: 1.6; font-family: Helvetica Neue, Arial, Hiragino Sans GB, STHeiti, Microsoft YaHei, WenQuanYi Micro Hei, SimSun, Song, sans-serif;">
<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 30px; margin-bottom: 20px; font-size: 30px;">1. 概述</h2>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">堆是一个完全二叉树，其中每个节点的值都大于（或小于）其所有孩子节点的值，Top K 问题是堆的一个典型应用。</p>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">在很多地方又被称为 <strong style="font-weight: bold;">优先级队列</strong>，JDK 中的<code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 90%; padding: 0 4px; color: #c7254e; background-color: #f9f2f4; white-space: nowrap; border-radius: 4px; margin: 0 4px;">PriorityQueue</code>就是基于堆实现的。</p>
<h2 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 30px; margin-bottom: 20px; font-size: 30px;">2. 实现</h2>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">和其他完全二叉树一样，堆通常用一个数组实现，同时用一个变量记录当前堆内元素个数。</p>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">对元素 i，它的左孩子和右孩子分别为 <span style="display:inline-block;margin:0"><span></span><span><span style="white-space: nowrap;"><span style="width: 3.098em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.562em; height: 0px; font-size: 120%;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.801em -0.533em); top: -2.557em; left: 0.003em;"><span><span style="font-family:STIXGeneral-Regular, serif;">2</span><span style="font-family:STIXGeneral-Italic, serif;">i</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.241em;">+</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.241em;">1</span></span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.004em; vertical-align: -0.139em;"></span></span></span></span></span>，<span style="display:inline-block;margin:0"><span></span><span><span style="white-space: nowrap;"><span style="width: 3.098em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.562em; height: 0px; font-size: 120%;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.801em -0.533em); top: -2.557em; left: 0.003em;"><span><span style="font-family:STIXGeneral-Regular, serif;">2</span><span style="font-family:STIXGeneral-Italic, serif;">i</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.241em;">+</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.241em;">2</span></span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.004em; vertical-align: -0.139em;"></span></span></span></span></span>，它的父节点为<span style="display:inline-block;margin:0"><span></span><span><span style="white-space: nowrap;"><span style="width: 2.979em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.443em; height: 0px; font-size: 120%;"><span style="position: absolute; clip: rect(0.658em 1000.003em 3.098em -0.414em); top: -2.199em; left: 0.003em;"><span><span><span><span style="padding-left: 0.122em; padding-right: 0.122em;"><span style="display: inline-block; position: relative; width: 2.146em; height: 0px;"><span style="position: absolute; clip: rect(1.729em 1000.003em 2.741em -0.473em); top: -3.211em; left: 50%; margin-left: -1.009em;"><span><span style="font-family:STIXGeneral-Italic, serif;">i</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.241em;">−</span><span style="font-family:STIXGeneral-Regular, serif; padding-left: 0.241em;">1</span></span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; clip: rect(1.729em 1000.003em 2.741em -0.533em); top: -1.842em; left: 50%; margin-left: -0.235em;"><span style="font-family:STIXGeneral-Regular, serif;">2</span><span style="display: inline-block; width: 0px; height: 2.562em;"></span></span><span style="position: absolute; clip: rect(0.836em 1000.003em 1.253em -0.533em); top: -1.307em; left: 0.003em;"><span style="border-left-width: 2.146em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em;"></span><span style="display: inline-block; width: 0px; height: 1.074em;"></span></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.205em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 2.575em; vertical-align: -0.925em;"></span></span></span></span></span>向下取整。</p>
<pre style="overflow: initial; font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 14px; display: block; padding: 0; margin: 0 0 10px; line-height: 1.6; word-break: break-all; word-wrap: break-word; color: #333333; background-color: #f5f5f5; border: none; border-radius: 0; white-space: pre-wrap; background: transparent;" xml:space="preserve"><code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: inherit; padding: 1em; color: #f8f8f2; background-color: transparent; white-space: pre-wrap; border-radius: 8px; display: block; background: #23241f; margin: 0 4px;"><span style="color: #F92672;">int</span>[] heap;
<span style="color: #F92672;">int</span> heapLength;

<span style="color: #75715e;">// helper funcs for parent/left child/right child fast access</span>
Integer parent(<span style="color: #F92672;">int</span> i){<span style="color: #F92672;">return</span> (i-<span style="color: #ae81ff;">1</span>)/<span style="color: #ae81ff;">2</span> &gt;= <span style="color: #ae81ff;">0</span> ? (i-<span style="color: #ae81ff;">1</span>)/<span style="color: #ae81ff;">2</span> : <span style="color: #F92672;">null</span>;}
Integer left(<span style="color: #F92672;">int</span> i){<span style="color: #F92672;">return</span> (<span style="color: #ae81ff;">2</span>*i + <span style="color: #ae81ff;">1</span>) &lt;= heapLength - <span style="color: #ae81ff;">1</span>? (<span style="color: #ae81ff;">2</span>*i + <span style="color: #ae81ff;">1</span>) : <span style="color: #F92672;">null</span>;}
Integer right(<span style="color: #F92672;">int</span> i){<span style="color: #F92672;">return</span> (<span style="color: #ae81ff;">2</span>*i + <span style="color: #ae81ff;">2</span>) &lt;= heapLength - <span style="color: #ae81ff;">1</span>? (<span style="color: #ae81ff;">2</span>*i + <span style="color: #ae81ff;">2</span>) : <span style="color: #F92672;">null</span>;}
</code></pre>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">堆常见的操作有：</p>
<ol style="margin-top: 0; margin-bottom: 10px; line-height: 1.6;">
<li style="line-height: 1.6;"><code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 90%; padding: 0 4px; color: #c7254e; background-color: #f9f2f4; white-space: nowrap; border-radius: 4px; margin: 0 4px;">init</code>：用一个集合初始化堆</li>
<li style="line-height: 1.6;"><code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 90%; padding: 0 4px; color: #c7254e; background-color: #f9f2f4; white-space: nowrap; border-radius: 4px; margin: 0 4px;">removeTop</code>：删除堆顶</li>
<li style="line-height: 1.6;"><code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 90%; padding: 0 4px; color: #c7254e; background-color: #f9f2f4; white-space: nowrap; border-radius: 4px; margin: 0 4px;">replaceTop</code>：用一个元素代替堆顶，并返回原堆顶</li>
</ol>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">堆也支持元素的增加、更新、删除等操作，但用的不多。</p>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">下面的讲解都是以小顶堆为例。</p>
<h3 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 30px; margin-bottom: 20px; font-size: 24px;">sink 和 float</h3>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;"><code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 90%; padding: 0 4px; color: #c7254e; background-color: #f9f2f4; white-space: nowrap; border-radius: 4px; margin: 0 4px;">sink</code>和<code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 90%; padding: 0 4px; color: #c7254e; background-color: #f9f2f4; white-space: nowrap; border-radius: 4px; margin: 0 4px;">float</code>是调整堆的两个核心动作。对于一个已经构造好了的对，当某个元素变大了，它需要往下下沉到合适的位置；反之则要上浮。</p>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;"><code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 90%; padding: 0 4px; color: #c7254e; background-color: #f9f2f4; white-space: nowrap; border-radius: 4px; margin: 0 4px;">sink</code> 的递归实现如下：</p>
<pre style="overflow: initial; font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 14px; display: block; padding: 0; margin: 0 0 10px; line-height: 1.6; word-break: break-all; word-wrap: break-word; color: #333333; background-color: #f5f5f5; border: none; border-radius: 0; white-space: pre-wrap; background: transparent;" xml:space="preserve"><code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: inherit; padding: 1em; color: #f8f8f2; background-color: transparent; white-space: pre-wrap; border-radius: 8px; display: block; background: #23241f; margin: 0 4px;"><span style="color: #F92672;">void</span> sink(<span style="color: #F92672;">int</span> i){
    Integer left = left(i),right = right(i);

    <span style="color: #75715e;">// 叶子节点，结束 sink 动作</span>
    <span style="color: #F92672;">if</span>(left == <span style="color: #F92672;">null</span> &amp;&amp; right == <span style="color: #F92672;">null</span>) <span style="color: #F92672;">return</span>;   

    <span style="color: #75715e;">// 如果只有左孩子且比它大，则交换二者的值，并继续 sink</span>
    <span style="color: #F92672;">if</span>(left != <span style="color: #F92672;">null</span> &amp;&amp; right == <span style="color: #F92672;">null</span> &amp;&amp; heap[i] &gt; heap[left]) {
        swap(i,left);
        sink(left);
        <span style="color: #F92672;">return</span>;
    }

    <span style="color: #75715e;">// 如果同时有左右孩子，则跟较小的孩子比较，如果比它大，则交换并继续 sink</span>
    <span style="color: #F92672;">if</span>(left != <span style="color: #F92672;">null</span> &amp;&amp; right != <span style="color: #F92672;">null</span>){
        <span style="color: #F92672;">int</span> min = heap[left] &lt; heap[right] ? left:right;
        <span style="color: #F92672;">if</span>(heap[i] &gt; heap[min]){
            swap(i,min);
            sink(min);
        }
    }
}
</code></pre>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;"><code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 90%; padding: 0 4px; color: #c7254e; background-color: #f9f2f4; white-space: nowrap; border-radius: 4px; margin: 0 4px;">float</code> 的逻辑类似。</p>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">二者的时间复杂度都是 O(logN)。</p>
<h3 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 30px; margin-bottom: 20px; font-size: 24px;">init</h3>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">从最后一个非叶子节点开始到根节点，依次对其调用<code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 90%; padding: 0 4px; color: #c7254e; background-color: #f9f2f4; white-space: nowrap; border-radius: 4px; margin: 0 4px;">sink()</code>调整堆即可：</p>
<pre style="overflow: initial; font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 14px; display: block; padding: 0; margin: 0 0 10px; line-height: 1.6; word-break: break-all; word-wrap: break-word; color: #333333; background-color: #f5f5f5; border: none; border-radius: 0; white-space: pre-wrap; background: transparent;" xml:space="preserve"><code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: inherit; padding: 1em; color: #f8f8f2; background-color: transparent; white-space: pre-wrap; border-radius: 8px; display: block; background: #23241f; margin: 0 4px;"><span style="color: #F92672;">void</span> initHeap(){
    <span style="color: #F92672;">for</span>(<span style="color: #F92672;">int</span> i = parent(heapLength - <span style="color: #ae81ff;">1</span>); i&gt;=<span style="color: #ae81ff;">0</span> ; i--){
        sink(i);
    }
}
</code></pre>
<h3 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 30px; margin-bottom: 20px; font-size: 24px;">removeTop</h3>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">用最后一个元素代替当前堆顶，并对其用<code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 90%; padding: 0 4px; color: #c7254e; background-color: #f9f2f4; white-space: nowrap; border-radius: 4px; margin: 0 4px;">sink()</code>调整堆：</p>
<pre style="overflow: initial; font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 14px; display: block; padding: 0; margin: 0 0 10px; line-height: 1.6; word-break: break-all; word-wrap: break-word; color: #333333; background-color: #f5f5f5; border: none; border-radius: 0; white-space: pre-wrap; background: transparent;" xml:space="preserve"><code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: inherit; padding: 1em; color: #f8f8f2; background-color: transparent; white-space: pre-wrap; border-radius: 8px; display: block; background: #23241f; margin: 0 4px;"><span style="color: #F92672;">int</span> removeTop(){
    <span style="color: #F92672;">int</span> top = heap[<span style="color: #ae81ff;">0</span>];
    heap[<span style="color: #ae81ff;">0</span>] = heap[heapLength-<span style="color: #ae81ff;">1</span>];
    heapLength -= <span style="color: #ae81ff;">1</span>;
    sink(<span style="color: #ae81ff;">0</span>);
    <span style="color: #F92672;">return</span> top;
}
</code></pre>
<h3 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 30px; margin-bottom: 20px; font-size: 24px;">replaceTop</h3>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">用指定元素代替当前堆顶，再调用<code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 90%; padding: 0 4px; color: #c7254e; background-color: #f9f2f4; white-space: nowrap; border-radius: 4px; margin: 0 4px;">sink()</code>：</p>
<pre style="overflow: initial; font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 14px; display: block; padding: 0; margin: 0 0 10px; line-height: 1.6; word-break: break-all; word-wrap: break-word; color: #333333; background-color: #f5f5f5; border: none; border-radius: 0; white-space: pre-wrap; background: transparent;" xml:space="preserve"><code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: inherit; padding: 1em; color: #f8f8f2; background-color: transparent; white-space: pre-wrap; border-radius: 8px; display: block; background: #23241f; margin: 0 4px;"><span style="color: #F92672;">int</span> replaceTop(<span style="color: #F92672;">int</span> n){
    <span style="color: #F92672;">int</span> top = heap[<span style="color: #ae81ff;">0</span>];
    heap[<span style="color: #ae81ff;">0</span>] = n;
    sink(<span style="color: #ae81ff;">0</span>);
    <span style="color: #F92672;">return</span> top;
}
</code></pre>
<h3 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 30px; margin-bottom: 20px; font-size: 24px;">add</h3>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">将元素加入数组最末，并用<code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 90%; padding: 0 4px; color: #c7254e; background-color: #f9f2f4; white-space: nowrap; border-radius: 4px; margin: 0 4px;">float()</code>将其上浮到合适位置。</p>
<h3 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 30px; margin-bottom: 20px; font-size: 24px;">update</h3>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">将新值和旧值比较，决定是用<code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 90%; padding: 0 4px; color: #c7254e; background-color: #f9f2f4; white-space: nowrap; border-radius: 4px; margin: 0 4px;">float()</code>还是<code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 90%; padding: 0 4px; color: #c7254e; background-color: #f9f2f4; white-space: nowrap; border-radius: 4px; margin: 0 4px;">sink()</code>调整堆。</p>
<h3 style="font-family: inherit; font-weight: bold; line-height: 1.1; color: inherit; margin-top: 30px; margin-bottom: 20px; font-size: 24px;">delete</h3>
<p style="margin: 0 0 10px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">将堆的最后一个元素放到该位置，再通过<code style="font-family: Menlo, Monaco, Consolas, Courier New, monospace; font-size: 90%; padding: 0 4px; color: #c7254e; background-color: #f9f2f4; white-space: nowrap; border-radius: 4px; margin: 0 4px;">float / sink</code>调整堆。</p>
</div>